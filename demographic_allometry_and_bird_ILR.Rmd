---
title: "demographic_allometry_and_bird_ILR"
output: html_document
---

```{r}
###############################################################################
# 0. Packages, constants, and centralized paths
###############################################################################

# Core data wrangling
library(dplyr)
library(readr)
library(stringr)
library(tibble)
library(forcats)

# Plotting
library(ggplot2)
library(cowplot)     # for plot_grid, get_legend, ggdraw
library(patchwork)   # for combining plots
library(ggtern)      # for ternary diagram

# Misc utilities
library(glue)        # for building label strings
library(grid)        # for unit()
library(scales)      # for alpha(), comma()

# Compositional data + zero replacement
library(compositions)
library(zCompositions)

# ---------------------------------------------------------------------------
# Global constants
# ---------------------------------------------------------------------------

# Buffer factor to convert maximum intrinsic growth rate (rm) to "usable" r
# rm is the theoretical maximum; r is scaled down to be more realistic.
R_BUFFER <- 0.8      # r = R_BUFFER * rm

# Marine taxa to exclude from mammal analyses (no terrestrial carrying capacity)
MARINE_ORDERS   <- c("Cetacea", "Sirenia")
MARINE_FAMILIES <- c("Phocidae", "Otariidae", "Odobenidae")
MAMMAL_MARINE_RMAX_SPECIES  <- "Enhydra lutris"
MAMMAL_MARINE_SIGMA_SPECIES <- c("Enhydra lutris", "Ursus maritimus")

# Neutral blue used in the main allometry figure (regression line colour)
neutral_blue <- "#3A6FB0"

# ---------------------------------------------------------------------------
# Centralized file paths for all raw inputs and cleaned outputs
# ---------------------------------------------------------------------------

PATHS <- list(
  # raw inputs
  mammal_rmax_raw     = "Data/Raw/mammal_rmax.txt",
  bird_traits_raw     = "Data/Raw/bird_data.txt",
  sigma_raw           = "Data/Raw/sigma.csv",

  # cleaned outputs (per-species summaries)
  mammal_rmax_out     = "Data/Clean/mammal_rmax.csv",
  bird_rmax_out       = "Data/Clean/bird_rmax.csv",
  mammal_sigma_out    = "Data/Clean/mammal_sigma.csv",
  bird_sigma_out      = "Data/Clean/bird_sigma.csv",
  bird_sigma_data_out = "Data/Clean/bird_sigma_data.csv",

  # ILR-related (coefficients already used by downstream bird pipeline)
  bird_ilr_coefs_out  = "Data/Clean/ilr_coefs.csv",
  bird_ilr_effects_in = "Data/Clean/ilr_effects.csv",

  # OLS prediction outputs (mass-grid predictions)
  pred_mammal_rmax    = "Data/Clean/pred_mammal_rmax.csv",
  pred_bird_rmax      = "Data/Clean/pred_bird_rmax.csv",
  pred_mammal_sigma   = "Data/Clean/pred_mammal_sigma.csv",
  pred_bird_sigma     = "Data/Clean/pred_bird_sigma.csv"
)
```

# 1. Mammals: build Species–Mass–r table (rm → r, excluding marine / bats)

```{r}
###############################################################################
# 1. Mammal rm → r (buffered), removing Chiroptera and marine mammals
###############################################################################

# Read raw mammal rm table
# - The file stores log10(Mass) and log10(rm) by species.
mammal_rmax <- read_tsv(PATHS$mammal_rmax_raw, show_col_types = FALSE) %>%
  # Standardize column names so they are easier to refer to
  rename(
    log10_M  = `log10(M)`,
    log10_rm = `log10(rm)`
  ) %>%
  # Keep only rows with a valid rm, and remove:
  #   - bats (Order == Chiroptera)
  #   - marine orders and families
  #   - explicitly listed marine species with rm
  filter(
    !is.na(log10_rm),
    Order != "Chiroptera",
    !(Order  %in% MARINE_ORDERS),
    !(Family %in% MARINE_FAMILIES),
    !(Species %in% MAMMAL_MARINE_RMAX_SPECIES)
  ) %>%
  # Convert log10-scale values back to linear scale:
  #   - Mass in grams
  #   - rm as maximum intrinsic growth rate in continuous time
  #   - r as buffered rm used in all downstream simulations
  mutate(
    Mass = 10^log10_M,
    rm   = 10^log10_rm,
    r    = rm * R_BUFFER
  ) %>%
  # Keep only the fields needed by the rest of the pipeline
  transmute(Species, Mass, r)

# Save the per-species mammal r dataset for reuse
write_csv(mammal_rmax, PATHS$mammal_rmax_out)
```

# 2. Birds: λ_max → rm → r using EltonTraits body mass

```{r}
###############################################################################
# 2. Bird λ_max → rm → r, using EltonTraits-like mass data
###############################################################################

# Load EltonTraits-like bird trait table
# This table contains species names, body mass, diet, and taxonomy.
bird_traits <- read_tsv(
  PATHS$bird_traits_raw,
  col_types = cols(.default = col_guess())
)

# Extract species-level body mass from the trait table
# - Standardize the column name to "Mass" (in grams)
# - Keep only Scientific name and Mass (other fields will be joined later)
bird_mass <- bird_traits %>%
  rename(Mass = `BodyMass-Value`) %>%
  transmute(Species = Scientific, Mass)

# Hard-coded maximum annual population growth (λ_max) for calibration species
# from Niel & Lebreton (2005). Species names must match the Scientific field.
bird_lambda <- tibble(
  Species = c(
    "Fulmarus glacialis", "Fratercula arctica", "Gyps fulvus",
    "Rissa tridactyla",   "Larus argentatus",   "Chen caerulescens",
    "Branta leucopsis",   "Phalacrocorax carbo","Larus ridibundus",
    "Ciconia ciconia",    "Sterna caspia",      "Parus major",
    "Petronia petronia"
  ),
  lambda = c(
    1.06, 1.09, 1.09,
    1.12, 1.13, 1.17, 1.18,
    1.19, 1.19, 1.21, 1.29,
    1.64, 2.15
  )
)

# Convert λ_max to continuous-time rm and buffered r, then join Mass
bird_rmax <- bird_lambda %>%
  mutate(
    rm = log(lambda),   # discrete-time λ → continuous-time rm
    r  = rm * R_BUFFER  # buffered rm (used in Ricker simulations)
  ) %>%
  # Join on species name to attach Mass from bird_mass
  inner_join(bird_mass, by = "Species") %>%
  # Keep only fields needed downstream
  dplyr::select(Species, Mass, r)

# Save the per-species bird r dataset
write_csv(bird_rmax, PATHS$bird_rmax_out)
```

# 3. σ (growth-rate variance) for mammals and birds

```{r}
###############################################################################
# 3. Growth-rate variance (σ) for mammals and birds
###############################################################################

# Read the raw σ table:
# - Columns include: Class, Order, Family, Genus, Species (epithet),
#   "Common Name", Mass, Vr (variance of growth rate), etc.
sigma_raw <- read_csv(PATHS$sigma_raw, show_col_types = FALSE) %>%
  # Standardize the common-name column name
  rename(Common_Name = `Common Name`) %>%
  # Construct the binomial species name "Genus species"
  mutate(
    Species = paste(Genus, Species),
    # Convert variance of r (Vr) to standard deviation (σ)
    sigma   = sqrt(Vr)
  )

# --------------------------
# Mammal σ
# --------------------------

mammal_sigma <- sigma_raw %>%
  # Keep only mammal species
  filter(
    Class  == "Mammalia",
    # Exclude marine orders, families, and explicit marine species with σ
    !(Order  %in% MARINE_ORDERS),
    !(Family %in% MARINE_FAMILIES),
    !(Species %in% MAMMAL_MARINE_SIGMA_SPECIES)
  ) %>%
  # Keep only columns needed downstream
  dplyr::select(Species, Mass, sigma, Common_Name)

write_csv(mammal_sigma, PATHS$mammal_sigma_out)

# --------------------------
# Bird σ
# --------------------------

bird_sigma <- sigma_raw %>%
  filter(
    Class == "Aves",
    # Remove species with problematic or outlier σ estimates
    Species != "Phalacrocorax harrisi",
    Species != "Gallirallus sylvestris"
  ) %>%
  dplyr::select(Species, Mass, sigma, Common_Name)

write_csv(bird_sigma, PATHS$bird_sigma_out)
```

# 4. Allometry figure: r and σ vs Mass for mammals and birds

```{r}
###############################################################################
# 4. Allometry figure: log10(r) and log10(σ) vs log10(Mass)
###############################################################################

# Custom theme used only for this 2×2 allometry grid.
# This follows your original styling to keep the figure visually identical.
theme_allometry <- function(base_size = 12) {
  theme_minimal(base_size = base_size) +
    theme(
      plot.title         = element_text(
        face  = "bold",
        size  = base_size + 2,
        margin = margin(b = 8)
      ),
      axis.title         = element_text(face = "bold", size = base_size + 1),
      axis.text          = element_text(color = "grey20"),
      panel.grid.minor   = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.major.y = element_line(color = "grey90"),
      strip.placement    = "outside",
      strip.switch.pad.grid = unit(2, "pt"),
      strip.text.y       = element_text(
        face   = "bold",
        size   = base_size + 3,
        margin = margin(r = 6)
      ),
      strip.text.x       = element_text(face = "bold", size = base_size + 1),
      strip.background   = element_rect(
        fill     = "grey94",
        color    = "grey65",
        linewidth = 0.6
      ),
      legend.position    = "none",
      panel.border       = element_rect(
        color    = "grey60",
        fill     = NA,
        linewidth = 0.7
      ),
      panel.spacing.x    = unit(4, "pt"),
      panel.spacing.y    = unit(6, "pt"),
      plot.margin        = margin(8, 8, 8, 8)
    )
}

# Build a single long-format table that stacks:
#   - mammals:  Mass vs r (metric = "r_m")
#   - birds:    Mass vs r (metric = "r_m")
#   - mammals:  Mass vs σ (metric = "sigma")
#   - birds:    Mass vs σ (metric = "sigma")
allometry_long <- bind_rows(
  transmute(mammal_rmax,  Mass, value = r,     taxon = "Mammals", metric = "r_m"),
  transmute(bird_rmax,    Mass, value = r,     taxon = "Birds",   metric = "r_m"),
  transmute(mammal_sigma, Mass, value = sigma, taxon = "Mammals", metric = "sigma"),
  transmute(bird_sigma,   Mass, value = sigma, taxon = "Birds",   metric = "sigma")
) %>%
  # Keep only positive, finite Mass and response
  filter(is.finite(Mass), is.finite(value), Mass > 0, value > 0) %>%
  # Add log10(Mass) and log10(response), and define factor labels
  mutate(
    logMass    = log10(Mass),
    logResp    = log10(value),
    taxon      = factor(taxon, levels = c("Mammals", "Birds")),
    metric_lab = factor(
      metric,
      levels = c("r_m", "sigma"),
      labels = c("r[m]", "\u03C3")  # parsed labels for facets
    )
  )

# For each (taxon, metric), fit log10(response) ~ log10(Mass) and
# prepare a parsed label with equation, R², and sample size n.
allometry_stats <- allometry_long %>%
  group_by(taxon, metric_lab) %>%
  do({
    fit <- lm(logResp ~ logMass, data = .)
    tibble(
      a  = unname(coef(fit)[1]),          # intercept
      b  = unname(coef(fit)[2]),          # slope
      r2 = summary(fit)$r.squared,        # coefficient of determination
      n  = nrow(.)
    )
  }) %>%
  ungroup() %>%
  mutate(
    a2  = format(round(a, 2), nsmall = 2),
    b2  = format(round(b, 2), nsmall = 2),
    r22 = format(round(r2, 2), nsmall = 2),
    lbl = ifelse(
      metric_lab == "r[m]",
      glue("atop(log[10](r[m])=={a2}+{b2}*log[10](M),~R^2=={r22}~~n=={n})"),
      glue("atop(log[10](sigma)=={a2}+{b2}*log[10](M),~R^2=={r22}~~n=={n})")
    )
  )

# Build the 2×2 allometry plot:
# - rows: r[m] vs σ
# - columns: Mammals vs Birds
# - each panel: scatter, regression line, and panel-specific label.
p_allometry <- ggplot(allometry_long, aes(x = logMass, y = logResp)) +
  geom_point(alpha = 0.65, size = 1.7, color = "grey35") +
  geom_smooth(
    method   = "lm",
    se       = FALSE,
    linewidth = 1.05,
    color    = neutral_blue
  ) +
  facet_grid(
    rows     = vars(metric_lab),
    cols     = vars(taxon),
    scales   = "free_x",                 # allow slight differences in mass range
    labeller = labeller(metric_lab = label_parsed),
    switch   = "y"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.26))) +
  scale_x_continuous(expand = expansion(mult = c(0.02, 0.03))) +
  labs(
    title = "Allometric relationship between body mass and demographic rate",
    x     = expression(log[10](Mass~(g))),
    y     = expression(log[10](parameter~value))
  ) +
  # Add equation / R² / n in the top-right corner of each panel
  geom_label(
    data        = allometry_stats,
    mapping     = aes(x = Inf, y = Inf, label = lbl),
    inherit.aes = FALSE,
    parse       = TRUE,
    hjust       = 1,
    vjust       = 1,
    size        = 3.3,
    color       = "grey10",
    label.size  = 0.2,
    label.padding = unit(3.5, "pt"),
    label.r       = unit(2.5, "pt"),
    fill          = alpha("white", 0.92)
  ) +
  coord_cartesian(clip = "on") +
  theme_allometry()

# Draw the allometry figure
p_allometry
# ggsave("Figures/allometry_grid.png", p_allometry, width = 8, height = 6, dpi = 300)
```

# 5. Bird σ + traits + grouped diets (bird_sigma_data)

```{r}
###############################################################################
# 5. Join bird σ to EltonTraits and construct grouped diet compositions
###############################################################################

# 5.1 Clean diet column names in the bird trait table
bird_traits_clean <- bird_traits %>%
  rename(
    Diet_Vend   = `Diet-Vend`,
    Diet_Vect   = `Diet-Vect`,
    Diet_Vfish  = `Diet-Vfish`,
    Diet_Vunk   = `Diet-Vunk`,
    Diet_Scav   = `Diet-Scav`,
    Diet_Fruit  = `Diet-Fruit`,
    Diet_Nect   = `Diet-Nect`,
    Diet_PlantO = `Diet-PlantO`,
    Diet_Seed   = `Diet-Seed`,
    Diet_Inv    = `Diet-Inv`,
    Diet_5Cat   = `Diet-5Cat`
  )

# 5.2 Prepare σ table for joining:
#     - convert Species and Common_Name to lowercase proxies for joining
bird_sigma_norm <- bird_sigma %>%
  mutate(
    Scientific = str_to_lower(Species),
    English    = str_to_lower(Common_Name)
  ) %>%
  dplyr::select(-Species, -Common_Name)

# 5.3 Prepare trait table for joining:
#     - lowercase Scientific and English names to align with bird_sigma_norm
bird_traits_norm <- bird_traits_clean %>%
  mutate(
    Scientific = str_to_lower(Scientific),
    English    = str_to_lower(English)
  )

# 5.4 Join σ to traits by Scientific name (primary key)
join_scientific <- bird_sigma_norm %>%
  inner_join(
    bird_traits_norm %>% dplyr::select(-English),
    by = "Scientific"
  )

# 5.5 Join σ to traits by English name (fallback for mismatched scientific names)
join_english <- bird_sigma_norm %>%
  inner_join(
    bird_traits_norm %>% dplyr::select(-Scientific),
    by = "English"
  )

# 5.6 Combine both joins and remove duplicates.
#     This captures species matched by either Scientific or English name.
bird_sigma_data <- bind_rows(join_scientific, join_english) %>%
  distinct()

# 5.7 Construct grouped diet categories (all values in percent, 0–100)
bird_sigma_data <- bird_sigma_data %>%
  mutate(
    # All vertebrate-based resources (including scavenging and unknown vertebrates)
    Diet_VertFishScav = Diet_Vend + Diet_Vect + Diet_Vfish + Diet_Vunk + Diet_Scav,
    # Fruit + nectar (reproductive parts and floral resources)
    Diet_FruiNect     = Diet_Fruit + Diet_Nect,
    # Other plant material + seeds
    Diet_PlantSeed    = Diet_PlantO + Diet_Seed,
    # All animal-based foods (vertebrates + invertebrates)
    Diet_AllAnimals   = Diet_VertFishScav + Diet_Inv,
    # All plant-based foods
    Diet_AllPlants    = Diet_FruiNect + Diet_PlantSeed
  )

# Save the enriched bird σ table with diet and traits
write_csv(bird_sigma_data, PATHS$bird_sigma_data_out)
```

# 6. ILR utilities and ILR model fits (2-, 3-, 4-part diets)

```{r}
###############################################################################
# 6. ILR utilities and ILR models for bird σ
###############################################################################

# Order diet factor levels by frequency once; used in figures for consistent colours
bird_sigma_data <- bird_sigma_data %>%
  mutate(Diet_5Cat = fct_infreq(Diet_5Cat))

diet_levels <- levels(bird_sigma_data$Diet_5Cat)

# ---------------------------------------------------------------------------
# Utility: zero replacement for compositional parts before ILR
# ---------------------------------------------------------------------------
# X is a data frame or matrix of compositional parts (columns) in [0,1]
# - If any zeros are present, use zCompositions::cmultRepl with CZM method
#   to replace zeros with small positive values that preserve relative scale.
zero_replace <- function(X) {
  X <- as.data.frame(X)
  if (any(X == 0, na.rm = TRUE)) {
    as.data.frame(zCompositions::cmultRepl(X, method = "CZM", label = 0))
  } else {
    X
  }
}

# ---------------------------------------------------------------------------
# Utility: transform compositional proportions to ILR coordinates
# ---------------------------------------------------------------------------
# X_prop is a data frame of parts (columns) that:
#   - are non-negative
#   - sum to 1 by row
# Returns a data frame of ILR coordinates (ilr1, ilr2, ...)
to_ilr <- function(X_prop) {
  ilr_df <- as.data.frame(ilr(acomp(X_prop)))
  names(ilr_df) <- paste0("ilr", seq_len(ncol(ilr_df)))
  ilr_df
}

# ---------------------------------------------------------------------------
# Fit ILR model: log10(σ) ~ log10(Mass) + ILR(parts)
# ---------------------------------------------------------------------------
# df must contain:
#   - Mass       : body mass (g)
#   - sigma      : growth-rate SD
#   - Diet_5Cat  : factor (for plotting only)
#   - columns in `parts`: diet percentages (0–100)
fit_ilr_model <- function(df, parts) {
  # Extract the compositional columns and convert percent → proportion (0–1)
  X <- df[, parts] / 100
  X <- zero_replace(X)
  ilr_df <- to_ilr(X)

  # Add ILR coordinates and log-transformed response/predictor
  out <- bind_cols(df, ilr_df) %>%
    mutate(
      logMass  = log10(Mass),
      logSigma = log10(sigma)
    )

  # Build formula string "logSigma ~ logMass + ilr1 + ilr2 + ..."
  rhs <- paste(c("logMass", names(ilr_df)), collapse = " + ")
  fml <- as.formula(paste("logSigma ~", rhs))

  # Fit linear model in ILR space
  m <- lm(fml, data = out)

  # Store model predictions in log10-space for plotting
  out$predicted_log10sigma <- as.numeric(predict(m, newdata = out))

  list(
    data  = out,
    model = m,
    r2    = round(summary(m)$r.squared, 3)
  )
}

# ---------------------------------------------------------------------------
# Utility: geometric-mean body mass (used as fixed Mass on simplex grid)
# ---------------------------------------------------------------------------
fixed_mass <- function(df) {
  10^mean(log10(df$Mass), na.rm = TRUE)
}

# ---------------------------------------------------------------------------
# Utility: simplex grid for 3-part compositions (ternary grid)
# ---------------------------------------------------------------------------
# Only 3-part case is needed here:
#   - parts: character vector of length 3 giving column names
#   - step:  step in the ternary simplex, e.g. 0.1 ⇒ 11 nodes per side
simplex_grid <- function(parts, step = 0.1) {
  stopifnot(length(parts) == 3)
  k <- round(1 / step)

  # Enumerate all non-negative integer triples (a, b, c) with a + b + c = k
  g <- expand.grid(a = 0:k, b = 0:k)
  g$c <- k - g$a - g$b
  g   <- g[g$c >= 0, , drop = FALSE]

  # Convert to proportions and assign user-specified column names
  out <- data.frame(
    A = g$a / k,
    B = g$b / k,
    C = g$c / k
  )
  names(out) <- parts
  out
}

# ---------------------------------------------------------------------------
# Helper for figure subtitles: count rows with complete Mass, prediction, diet
# ---------------------------------------------------------------------------
n_complete <- function(df) {
  sum(complete.cases(df$logMass, df$predicted_log10sigma, df$Diet_5Cat))
}

# ---------------------------------------------------------------------------
# Fit 2-, 3-, and 4-part ILR models
# ---------------------------------------------------------------------------

# 2-part: All plants vs all animals
parts_1d <- c("Diet_AllPlants", "Diet_AllAnimals")
fit1 <- fit_ilr_model(bird_sigma_data, parts_1d)

# 3-part: Invertebrates vs plants vs vertebrates (used downstream)
parts_2d <- c("Diet_Inv", "Diet_AllPlants", "Diet_VertFishScav")
fit2 <- fit_ilr_model(bird_sigma_data, parts_2d)

# 4-part: Invertebrates, vertebrates, plant/seed, fruit/nectar
parts_3d <- c("Diet_Inv", "Diet_VertFishScav", "Diet_PlantSeed", "Diet_FruiNect")
fit3 <- fit_ilr_model(bird_sigma_data, parts_3d)

# Compute BIC values (for reporting / figure subtitles)
fit1$bic <- round(BIC(fit1$model), 1)
fit2$bic <- round(BIC(fit2$model), 1)
fit3$bic <- round(BIC(fit3$model), 1)

# Save 3-part ILR regression coefficients (intercept, logMass slope, ILR slopes)
# These are used later when predicting bird σ on a body-mass grid.
write.csv(fit2$model$coefficients, PATHS$bird_ilr_coefs_out)
```

# 7. Figure 1: Diet composition by order + σ–Mass by diet

```{r}
###############################################################################
# 7. Figure 1: Diet composition by order + σ–Mass coloured by diet
###############################################################################

# Restrict to orders with at least 5 species with σ estimates to avoid noisy bars
df_order5 <- bird_sigma_data %>%
  group_by(IOCOrder) %>%
  filter(n() >= 5) %>%
  ungroup() %>%
  mutate(IOCOrder = fct_infreq(IOCOrder))

# Define a discrete colour palette for Diet_5Cat with fixed ordering
diet_pal <- setNames(scales::hue_pal()(length(diet_levels)), diet_levels)

# ---- Panel 1A: stacked bar of diet composition by order -----------------

order_diet_counts <- df_order5 %>%
  count(IOCOrder, Diet_5Cat, .drop = FALSE)

p_diet_comp <- ggplot(order_diet_counts, aes(x = IOCOrder, y = n, fill = Diet_5Cat)) +
  geom_col() +
  labs(
    x    = "Order",
    y    = "Number of species",
    fill = "Diet category"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title       = element_text(face = "bold"),
    axis.text.x      = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  ) +
  scale_fill_manual(values = diet_pal, limits = diet_levels, drop = FALSE)

# ---- Panel 1B: σ vs Mass scatter, coloured by diet ----------------------

p_diet_scatter <- bird_sigma_data %>%
  filter(is.finite(Mass), is.finite(sigma), Mass > 0, sigma > 0) %>%
  ggplot(aes(x = log10(Mass), y = log10(sigma), color = Diet_5Cat)) +
  geom_point(alpha = 0.7, size = 1.8) +
  scale_color_manual(values = diet_pal, limits = diet_levels, drop = FALSE) +
  labs(
    x     = expression(log[10](Mass)),
    y     = expression(log[10](sigma)),
    color = "Diet category"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title       = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )

# ---- Combine panels into a single figure with shared legend -------------

# Remove titles and legends inside the panel area to create clean blocks
p_diet_comp_nt    <- p_diet_comp    + labs(title = NULL) + theme(legend.position = "none")
p_diet_scatter_nt <- p_diet_scatter + labs(title = NULL) + guides(color = "none")

# Title grobs above each column
title_left <- ggdraw() +
  draw_label(
    "Diet composition by order (≥ 5 species)",
    fontface = "bold",
    x        = 0,
    hjust    = 0
  ) +
  theme(plot.margin = margin(0, 0, 4, 6))

title_right <- ggdraw() +
  draw_label(
    "Variance–mass relationship by diet",
    fontface = "bold",
    x        = 0,
    hjust    = 0
  ) +
  theme(plot.margin = margin(0, 0, 4, 6))

# Build left and right columns (title + panel)
left_block  <- plot_grid(title_left,  p_diet_comp_nt,    ncol = 1, rel_heights = c(0.12, 1))
right_block <- plot_grid(title_right, p_diet_scatter_nt, ncol = 1, rel_heights = c(0.12, 1))

# Extract a single shared legend for diet categories
shared_legend <- get_legend(
  p_diet_comp +
    theme(
      legend.position   = "bottom",
      legend.box.margin = margin(t = 6),
      legend.title      = element_text(face = "bold")
    )
)

# Combine left and right blocks with a spacer
row_panels <- plot_grid(
  left_block,
  NULL,
  right_block,
  ncol       = 3,
  rel_widths = c(1.1, 0.06, 1),
  align      = "hv"
)

# Final combined figure: row of panels + shared legend below
fig_bird_diet_phylo <- plot_grid(
  row_panels,
  shared_legend,
  ncol        = 1,
  rel_heights = c(1, 0.12)
)

fig_bird_diet_phylo
# ggsave("Figures/bird_diet_phylo.png", fig_bird_diet_phylo, width = 10, height = 5, dpi = 300)
```

# 8. Figure 2: Binary vs Quaternary ILR comparison

```{r}
###############################################################################
# 8. Figure 2: Binary vs Quaternary ILR models (predicted log10(σ))
###############################################################################

# Panel builder for ILR fits:
# - uses predicted log10(σ) vs log10(Mass)
# - colours points by Diet_5Cat
panel_ilr <- function(fit, title_main) {
  d <- fit$data %>%
    mutate(Diet_5Cat = factor(Diet_5Cat, levels = diet_levels))

  ggplot(d, aes(x = logMass, y = predicted_log10sigma, color = Diet_5Cat)) +
    geom_point(alpha = 0.7, size = 1.8) +
    scale_color_viridis_d(
      name   = "Diet category",
      limits = diet_levels,
      drop   = FALSE
    ) +
    labs(
      title    = title_main,
      subtitle = glue(
        "N = {n_complete(d)}   R^2 = {format(round(fit$r2, 2), nsmall = 2)}   BIC = {fit$bic}"
      ),
      x        = expression(log[10](Mass)),
      y        = expression(paste("Predicted ", log[10](sigma)))
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title       = element_text(face = "bold"),
      plot.subtitle    = element_text(color = "grey20"),
      panel.grid.minor = element_blank()
    )
}

# Build the binary (plants vs animals) and quaternary (4-part) ILR panels
p_ilr_bin <- panel_ilr(fit1, "Binary ILR")
p_ilr_qua <- panel_ilr(fit3, "Quaternary ILR")

# Place panels side by side and collect the legend at the bottom
fig_ilr_compare <- (p_ilr_bin + p_ilr_qua + plot_layout(widths = c(1, 1), guides = "collect")) &
  theme(
    legend.position   = "bottom",
    legend.box.margin = margin(t = 6)
  )

fig_ilr_compare
# ggsave("Figures/ilr_compare.png", fig_ilr_compare, width = 10, height = 4.5, dpi = 300)
```

# 9. Figure 3: Ternary ILR performance (3-part diet model)

```{r}
###############################################################################
# 9. Figure 3: Ternary ILR (3-part diet) – scatter + ternary diagram
###############################################################################

# Build ternary grid over the 3-part composition (Inv, AllPlants, VertFishScav)
g2 <- simplex_grid(parts_2d, step = 0.1)

# Convert grid to ILR coordinates and add fixed body mass for prediction
g2_ilr <- to_ilr(zero_replace(g2))

g2 <- bind_cols(g2, g2_ilr) %>%
  mutate(
    Mass                  = fixed_mass(bird_sigma_data),
    logMass               = log10(Mass),
    predicted_log10sigma  = as.numeric(predict(fit2$model, newdata = cur_data()))
  )

# Left panel: predicted log10(σ) vs log10(Mass), coloured by diet category
d2 <- fit2$data %>%
  mutate(Diet_5Cat = factor(Diet_5Cat, levels = diet_levels))

p_ilr_tern_scatter <- ggplot(d2, aes(x = logMass, y = predicted_log10sigma, color = Diet_5Cat)) +
  geom_point(alpha = 0.7, size = 1.8) +
  scale_color_viridis_d(
    name   = "Diet category",
    limits = diet_levels,
    drop   = FALSE
  ) +
  labs(
    title    = "Ternary ILR",
    subtitle = glue(
      "N = {n_complete(d2)}   R^2 = {format(round(fit2$r2, 2), nsmall = 2)}   BIC = {fit2$bic}"
    ),
    x        = expression(log[10](Mass)),
    y        = expression(paste("Predicted ", log[10](sigma)))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title       = element_text(face = "bold"),
    plot.subtitle    = element_text(color = "grey20"),
    panel.grid.minor = element_blank(),
    plot.margin      = margin(t = 6, r = 12, b = 6, l = 6)
  )

# Right panel: ternary diagram of composition vs predicted log10(σ)
g2_plot <- g2 %>%
  rename(
    R = Diet_Inv,
    L = Diet_AllPlants,
    T = Diet_VertFishScav
  )

p_ilr_tern_diagram <- ggtern(
  data    = g2_plot,
  mapping = aes(x = L, y = T, z = R, fill = predicted_log10sigma)
) +
  geom_point(shape = 21, size = 2, stroke = 0.2, color = "black") +
  theme_showarrows() +
  Tlab("T") + Llab("L") + Rlab("R") +
  labs(
    x     = NULL,
    y     = NULL,
    z     = NULL,
    title = "Effect of diet on variance",
    subtitle = glue(
      "Predicted \u03C3 at fixed body mass ({comma(round(unique(g2_plot$Mass)))} g)"
    )
  ) +
  scale_fill_viridis_c(
    name    = expression(paste("Predicted ", log[10](sigma))),
    option  = "plasma",
    direction = 1
  ) +
  guides(
    fill = guide_colorbar(
      title.position = "top",
      title.hjust    = 0.5,
      barwidth       = unit(120, "pt"),
      barheight      = unit(6, "pt")
    )
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title        = element_text(face = "bold"),
    plot.subtitle     = element_text(color = "grey20"),
    panel.grid.minor  = element_blank(),
    tern.axis.title.T = element_text(face = "bold"),
    tern.axis.title.L = element_text(face = "bold"),
    tern.axis.title.R = element_text(face = "bold"),
    plot.margin       = margin(t = 6, r = 6, b = 6, l = 12)
  )

# Extract legends from both panels
leg_diet <- get_legend(
  p_ilr_tern_scatter +
    theme(
      legend.position   = "bottom",
      legend.box.margin = margin(t = 4, b = 10),
      legend.title      = element_text(face = "bold")
    )
)

leg_sigma <- get_legend(
  p_ilr_tern_diagram +
    theme(
      legend.position   = "bottom",
      legend.box.margin = margin(t = 4, b = 8),
      legend.title      = element_text(face = "bold")
    )
)

# Remove legends from the main panel objects
p_ilr_tern_scatter_nl <- p_ilr_tern_scatter + guides(color = "none")
p_ilr_tern_diagram_nl <- p_ilr_tern_diagram + theme(legend.position = "none")

# Right column: ternary panel + its colourbar legend
right_col <- p_ilr_tern_diagram_nl / wrap_elements(leg_sigma) +
  plot_layout(heights = c(1, 0.12))

# Row: scatter | spacer | ternary+colorbar
panels_row <- p_ilr_tern_scatter_nl +
  plot_spacer() +
  right_col +
  plot_layout(widths = c(1, 0.06, 1.05))

# Add diet legend below the whole figure
fig_ilr_performance <- (panels_row / wrap_elements(leg_diet)) +
  plot_layout(heights = c(1, 0.18)) +
  plot_annotation(theme = theme(plot.margin = margin(6, 6, 22, 6)))

fig_ilr_performance
# ggsave("Figures/ilr_performance.png", fig_ilr_performance, width = 10, height = 5.8, dpi = 300)
```

```{r}
# Relevant diet combinations (Diet_Inv, Diet_AllPlants, Diet_VertFishScav) in %
combos <- c(
  "100_0_0",  "20_0_80",  "80_20_0",  "10_90_0",  "0_0_100",
  "0_100_0",  "20_80_0",  "30_70_0",  "90_10_0",  "40_30_30",
  "80_0_20",  "70_30_0",  "50_50_0",  "10_0_90",  "90_0_10",
  "70_0_30",  "60_0_40",  "30_0_70",  "50_0_50",  "70_10_20",
  "60_20_20", "40_60_0"
)

# Parse combos → % diet table in ILR order
split_mat  <- do.call(rbind, strsplit(combos, "_"))
diet_grid  <- tibble::tibble(
  Diet_Inv          = as.numeric(split_mat[, 1]),
  Diet_AllPlants    = as.numeric(split_mat[, 2]),
  Diet_VertFishScav = as.numeric(split_mat[, 3])
)

# Proportions → ILR coordinates
X_prop   <- zero_replace(diet_grid / 100)
ilr_grid <- to_ilr(X_prop)

# ILR slopes from 3-part model (fit2)
coefs    <- coef(fit2$model)
beta_ilr <- unname(coefs[grepl("^ilr", names(coefs))])

# ILR effect for each diet combo
effect <- as.numeric(as.matrix(ilr_grid) %*% beta_ilr)

# ilr_effects table: combo string, effect, and component %s
ilr_effects <- dplyr::bind_cols(
  tibble::tibble(combo = combos, effect = effect),
  diet_grid
)

readr::write_csv(ilr_effects, PATHS$bird_ilr_effects_in)
```

# 10. OLS allometry + predictions on mass grids

```{r}
###############################################################################
# 10. OLS allometry and predictions on regular mass grids
###############################################################################

# Goal:
#   1. Fit log10–log10 OLS allometries:
#        - mammals: log10(r)     ~ log10(Mass)
#                   log10(sigma) ~ log10(Mass)
#        - birds:   log10(r)     ~ log10(Mass)
#      (bird sigma vs Mass is handled via ILR coefficients + diet scenarios)
#   2. Predict r and sigma on regular mass sequences for mammals and birds.
#   3. Combine ILR-derived bird sigma effects with log10(Mass) to build a
#      Mass × ILR-scenario matrix of bird σ predictions.

# 10.1 Fit simple log10–log10 OLS allometries
fit_mammal_rmax  <- lm(log10(r)     ~ log10(Mass), data = mammal_rmax)
fit_bird_rmax    <- lm(log10(r)     ~ log10(Mass), data = bird_rmax)
fit_mammal_sigma <- lm(log10(sigma) ~ log10(Mass), data = mammal_sigma)

# 10.2 Build mass grids (31 log-spaced values for each group)
mammal_mass_seq <- 10^seq(log10(2), log10(4750000), length.out = 31)
bird_mass_seq   <- 10^seq(log10(2), log10(11236),   length.out = 31)

mammal_grid <- tibble(Mass = mammal_mass_seq)
bird_grid   <- tibble(Mass = bird_mass_seq)

# 10.3 Predict and back-transform to original scale (r, σ)
mammal_pred_rmax <- mammal_grid %>%
  mutate(r = 10^predict(fit_mammal_rmax, newdata = cur_data()))

bird_pred_rmax <- bird_grid %>%
  mutate(r = 10^predict(fit_bird_rmax, newdata = cur_data()))

mammal_pred_sigma <- mammal_grid %>%
  mutate(sigma = 10^predict(fit_mammal_sigma, newdata = cur_data()))

# 10.4 ILR-based bird σ predictions across mass grid
#      (uses saved ILR coefficients and precomputed ILR "effects")

# ilr_coefs:
#   - written earlier via write.csv(fit2$model$coefficients, ...)
#   - has a row for each parameter, with:
#       column 1: row names (parameter names)
#       column 2: numeric coefficient values
ilr_coefs   <- read_csv(PATHS$bird_ilr_coefs_out, show_col_types = FALSE)
ilr_effects <- read_csv(PATHS$bird_ilr_effects_in, show_col_types = FALSE)

# Extract intercept and slope for log10(Mass) from coefficient column
intercept   <- ilr_coefs[[2]][1]
log10_mass  <- ilr_coefs[[2]][2]

# ILR effect per diet combination + labels for each column
ilr_effect_vals <- ilr_effects$effect          # numeric ILR effects
combo_labels    <- ilr_effects$combo           # e.g. "100_0_0", "20_0_80", ...

# For each combination of Mass (rows) and ILR scenario (columns), compute:
#   log10(sigma) = intercept + log10_mass * log10(Mass) + ilr_effect
#   sigma        = 10^(log10(sigma))
logM <- log10(bird_mass_seq)

pred_matrix <- outer(
  X = logM,
  Y = ilr_effect_vals,
  FUN = function(logM_i, effect_j) {
    10^(intercept + log10_mass * logM_i + effect_j)
  }
)

# Wrap predictions into tibble:
#   - one row per Mass
#   - one column per diet combination (named by the combo string)
bird_pred_sigma <- as_tibble(pred_matrix)
colnames(bird_pred_sigma) <- combo_labels

bird_pred_sigma <- bind_cols(bird_grid, bird_pred_sigma)

# 10.5 Write all prediction tables to CSV for downstream use
write_csv(mammal_pred_rmax,  PATHS$pred_mammal_rmax)
write_csv(bird_pred_rmax,    PATHS$pred_bird_rmax)
write_csv(mammal_pred_sigma, PATHS$pred_mammal_sigma)
write_csv(bird_pred_sigma,   PATHS$pred_bird_sigma)
```